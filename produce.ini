[]
default =
  data/baseline.300/avg.dev.eval

[data/%{version}.%{dim}/avg.%{part}.eval]
path = data/%{version}.%{dim}
deps =
  %{path}/1/%{part}.eval
  %{path}/2/%{part}.eval
  %{path}/3/%{part}.eval
  %{path}/4/%{part}.eval
  %{path}/5/%{part}.eval
recipe =
  echo -n "Acc(POS) = " > %{target}
  cat %{path}/*/%{part}.eval | grep "POS" | cut -d ' ' -f 3 | awk '{ total += $1; count++ } END { print total/count }' >> %{target}
  echo -n "UAS = " >> %{target}
  cat %{path}/*/%{part}.eval | grep "UAS" | cut -d ' ' -f 3 | awk '{ total += $1; count++ } END { print total/count }' >> %{target}
  echo -n "Acc(STag) = " >> %{target}
  cat %{path}/*/%{part}.eval | grep "STag" | cut -d ' ' -f 3 | awk '{ total += $1; count++ } END { print total/count }' >> %{target}
  cat %{target}

[data/%{version}.%{dim}/%{exp}/%{part}.eval]
dep.french_twg = TWG/data/french/french_twg
dep.gold = %{french_twg}/%{part}.supertags
dep.pred = data/%{version}.%{dim}/%{exp}/%{part}.pred.supertags
recipe =
  python -m supertagger eval --gold %{gold} --pred %{pred} > %{target}
  cat %{target}

[data/%{version}.%{dim}/%{exp}/%{part}.pred.supertags]
dep.fastText = data/fastText/fr/cc.fr.%{dim}.bin
dep.french_twg = TWG/data/french/french_twg
dep.input = %{french_twg}/%{part}.supertags
dep.model = data/%{version}.%{dim}/%{exp}/model.pth
recipe =
  python -m supertagger tag -i %{input} -l %{model} -f %{fastText} > %{target}

[data/%{version}.%{dim}/%{exp}/model.pth]
dep.fastText = data/fastText/fr/cc.fr.%{dim}.bin
dep.french_twg = TWG/data/french/french_twg
dep.train = %{french_twg}/train.supertags
dep.dev = %{french_twg}/dev.supertags
dep.config = config/%{version}.json
recipe =
  mkdir -p $(dirname %{target})
  python -m supertagger train --model-config %{config} --emb %{dim} -t %{train} -d %{dev} -f %{fastText} --save %{target}

##################################################
# Embeddings
##################################################

[data/fastText/fr/cc.fr.100.bin.gz]
recipe =
  mkdir -p $(dirname %{target})
  wget https://user.phil.hhu.de/~waszczuk/treegrasp/fasttext/cc.fr.100.bin.gz -P $(dirname %{target})

[data/fastText/%{lang}/cc.%{lang}.300.bin.gz]
recipe =
  mkdir -p $(dirname %{target})
  wget https://dl.fbaipublicfiles.com/fasttext/vectors-crawl/cc.%{lang}.300.bin.gz -P $(dirname %{target})

[data/fastText/%{lang}/%{name}.bin]
dep.gz = data/fastText/%{lang}/%{name}.bin.gz
recipe =
  gunzip %{gz} -c > %{target}
